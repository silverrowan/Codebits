/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var d=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var y=(o,s)=>{for(var e in s)d(o,e,{get:s[e],enumerable:!0})},v=(o,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of w(s))!k.call(o,a)&&a!==e&&d(o,a,{get:()=>s[a],enumerable:!(t=f(s,a))||t.enumerable});return o};var E=o=>v(d({},"__esModule",{value:!0}),o);var S={};y(S,{default:()=>g});module.exports=E(S);var i=require("obsidian"),P={enabled:!1,apiKey:null,apiUrl:null,defaultProject:null,ignoreList:[],projectAssociations:[],debugModeEnabled:!1},g=class extends i.Plugin{constructor(){super(...arguments);this.lastHeartbeat=0;this.maxHeartbeatInterval=12e4;this.lastRequestWasError=!1}async onload(){await this.migratePluginData(),await this.loadSettings(),this.settings.debugModeEnabled&&console.info("Loading wakatime-kvh"),this.statusBar=this.addStatusBarItem(),this.updateStatusBarText(),this.addCommand({id:"wakatime-plugin-toggle-enabled",name:"Enable/Disable the plugin",callback:async()=>{this.settings.enabled=!this.settings.enabled,await this.saveSettings(),new i.Notice("Wakatime Plugin is now "+(this.settings.enabled?"enabled":"disabled")),this.updateStatusBarText()}}),this.addSettingTab(new p(this.app,this)),this.setupEventListeners()}onunload(){}async migratePluginData(){var e;typeof((e=this.settings)==null?void 0:e.debugModeEnabled)!="undefined"&&(this.settings.debugModeEnabled=!1,await this.saveSettings())}async loadSettings(){this.settings=Object.assign({},P,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.settings.debugModeEnabled&&console.info("Saved new settings",{settings:this.settings})}setupEventListeners(){this.registerDomEvent(document,"click",()=>{this.onEvent(!1)}),this.registerDomEvent(document,"keydown",()=>{this.onEvent(!1)})}onEvent(e){if(this.settings.debugModeEnabled&&console.info("Received DOM event"),!this.settings.enabled)return;let t=this.app.workspace.getActiveViewOfType(i.FileView);if(!t)return;let a=this.app.workspace.getActiveFile();if(!a||this.settings.ignoreList.some(h=>h.contains(a.path)||a.path.contains(h)))return;let l=Date.now(),n=null;t instanceof i.MarkdownView&&(n=t.editor.getCursor()),(e||this.enoughTimePassed(l)||this.lastFile!==a.path)&&(this.sendHeartbeat(a,l,n==null?void 0:n.line,n==null?void 0:n.ch,e),this.lastFile=a.path,this.lastHeartbeat=l)}enoughTimePassed(e){return this.lastHeartbeat+this.maxHeartbeatInterval<e}sendHeartbeat(e,t,a,l,n){if(!this.settings.enabled)return;let h=`${this.settings.apiUrl?this.settings.apiUrl:"https://api.wakatime.com"}/api/v1/users/current/heartbeats`,c=`Basic ${btoa(this.settings.apiKey)}`,b=`/${this.app.vault.getName()}/${e.path}`,u=this.getLanguageForFile(e),m=this.getProjectForFile(e);this.settings.debugModeEnabled&&console.info("Sending heartbeat",{url:h,auth:c,filePath:b,cursorPosition:l,isWrite:n,lang:u,project:m}),(0,i.requestUrl)({url:h,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:c},body:JSON.stringify({time:t/1e3,entity:b,type:"file",project:m,language:u,is_write:n,cursorpos:l,lineno:a,editor:"Obsidian",category:u?"writing":"reading"})}).then(r=>{if(this.settings.debugModeEnabled&&console.info("Response from sending heartbeat",r),r.status>=300)throw this.updateStatusBarText("Network Error"),this.lastRequestWasError||new i.Notice("Could not send data to Wakatime. Please check the logs."),this.lastRequestWasError=!0,new Error("Network response was not ok: "+r.text);return r.json}).then(()=>{this.updateStatusBarText(),this.lastRequestWasError=!1}).catch(r=>{this.settings.debugModeEnabled&&console.info("Error while sending heartbeat",r),this.updateStatusBarText("Unexpected Error"),this.lastRequestWasError||new i.Notice("Could not send data to Wakatime. Please check the logs."),console.error("There was a problem with the fetch operation:",r),this.lastRequestWasError=!0})}getProjectForFile(e){for(let t of this.settings.projectAssociations){let[a,l]=t.split("@");if(!(!a||!l||t.split("@").length!==2)&&e.path.includes(a))return l}return this.settings.defaultProject?this.settings.defaultProject:this.app.vault.getName()}getLanguageForFile(e){switch(e.extension){case"md":return"Markdown";default:return null}}updateStatusBarText(e=null){let t=this.settings.enabled?"Enabled":"Disabled";this.statusBar.setText("\u23F1\uFE0F "+(e!==null?e:t))}},p=class extends i.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),new i.Setting(s).setName("Basic setup").setHeading(),new i.Setting(s).setName("Enable the plugin").setDesc("Once you configured the plugin to your needs, enable it here.").setClass("wakatimekvh-input").addToggle(e=>e.setValue(this.plugin.settings.enabled).onChange(async t=>{if(!e.disabled){if(!this.plugin.settings.apiKey){new i.Notice("Please set a valid API key first."),e.setDisabled(!0).setValue(!1);return}this.plugin.settings.enabled=t,await this.plugin.saveSettings(),this.plugin.updateStatusBarText()}})),new i.Setting(s).setName("API key").setDesc("Enter your Wakatime / Wakapi API key.").setClass("wakatimekvh-input").addText(e=>e.setPlaceholder("81cee032-f24...").setValue(this.plugin.settings.apiKey?this.plugin.settings.apiKey:"").onChange(async t=>{this.plugin.settings.apiKey=t!==""?t:null,await this.plugin.saveSettings()})),new i.Setting(s).setName("Optional configuration").setHeading(),new i.Setting(s).setName("Wakapi URL").setDesc("Set the URL of your Wakapi setup here. Leave it blank if you want to use Wakatime.").setClass("wakatimekvh-input").addText(e=>e.setPlaceholder("https://wakapi.my-apps.com").setValue(this.plugin.settings.apiUrl?this.plugin.settings.apiUrl:"").onChange(async t=>{this.plugin.settings.apiUrl=t!==""?t:null,await this.plugin.saveSettings()})),new i.Setting(s).setName("Default project").setDesc("Set a specific project for your Vault. If empty, the Vault name will be used").setClass("wakatimekvh-input").addText(e=>e.setPlaceholder("My Project").setValue(this.plugin.settings.defaultProject?this.plugin.settings.defaultProject:"").onChange(async t=>{this.plugin.settings.defaultProject=t!==""?t:null,await this.plugin.saveSettings()})),new i.Setting(s).setName("Ignore list").setDesc(`Specify paths that should be ignored and not tracked. One entry per line.
Paths may either be absolute or relative from the root of your Vault.`).setClass("wakatimekvh-textarea").addTextArea(e=>e.setPlaceholder(`/Users/kevin/Obsidian Notes/some/ignored/folder
or
some/ignored/folder/specific note.md`).setValue(this.plugin.settings.ignoreList.join(`
`)).onChange(async t=>{this.plugin.settings.ignoreList=t.length>0?t.split(`
`):[],await this.plugin.saveSettings()})),new i.Setting(s).setName("Project association").setDesc(`Define which paths or files should be assigned a specific project. Use the [path]@[project name] syntax.
Paths may either be absolute or relative from the root of your Vault.`).setClass("wakatimekvh-textarea").addTextArea(e=>e.setPlaceholder(`/Users/kevin/Obsidian Notes/path/to/project@myProject
or
path/to/project/notes.md@another Project`).setValue(this.plugin.settings.projectAssociations.join(`
`)).onChange(async t=>{this.plugin.settings.projectAssociations=t.length>0?t.split(`
`):[],await this.plugin.saveSettings()})),new i.Setting(s).setName("Advanced settings").setHeading(),new i.Setting(s).setName("Debug mode").setDesc("Enable the debug mode in case you are having issues. The plugin will then log more details about what it is doing to the Console.").setClass("wakatimekvh-input").addToggle(e=>e.setValue(this.plugin.settings.debugModeEnabled).onChange(async t=>{this.plugin.settings.debugModeEnabled=t,await this.plugin.saveSettings(),this.plugin.updateStatusBarText()})),s.createEl("br"),s.createEl("hr"),s.createEl("small").innerHTML='\u2764\uFE0F Support my work via <a href="https://patreon.com/Kovah" target="_blank">Patreon</a>, <a href="https://github.com/Kovah" target="_blank">GitHub Sponsors</a> or <a href="https://liberapay.com/kovah" target="_blank">Liberapay</a>'}};

/* nosourcemap */